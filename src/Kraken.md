# Starknet Kraken Sequencer 
En este cap铆tulo, exploraremos Kraken, uno de los Secuenciadores que busca optimizar y mejorar el rendimiento. Kraken es una implementaci贸n descentralizada de un secuenciador dise帽ado por Lambda Class con el prop贸sito de escalar Starknet. 

> **Nota:** El c贸digo actual de consenso se basa en gran medida en la implementaci贸n de [Albert Sonnino's (asonnino) implementation](https://github.com/asonnino/hotstuff/), la cual se centr贸 en la investigaci贸n en lugar de la aplicaci贸n. Las modificaciones fueron realizadas por Lambda Class, principalmente en la estructura del nodo, para permitir el procesamiento de transacciones para bloques confirmados.

En este an谩lisis detallaremos sus diferentes m贸dulos y posibles implementaciones, analizemos como el secuenciador puede dividirse en (aproximadamente) 3 m贸dulos intercambiables:

## M贸dulo Mempool 
El m贸dulo Mempool, conocido como [**Narwhal**](https://arxiv.org/pdf/2105.11827.pdf), almacena las transacciones recibidas. Narwhal se especializa en la difusi贸n y el almacenamiento de historias causales de transacciones. Est谩 dise帽ado para funcionar con alta eficiencia en la difusi贸n y almacenamiento de transacciones, tolerando incluso fallas en la red. Narwhal es escalable y puede ser implementado con m煤ltiples trabajadores en cada validador, con un alto rendimiento demostrado. La investigaci贸n en Narwhal y Tusk propone la separaci贸n de la difusi贸n confiable de transacciones de su ordenamiento, habilitando un consenso de alto rendimiento y tolerancia a fallas bizantinas. La combinaci贸n de Narwhal con un protocolo de consenso parcialmente sincr贸nico (Narwhal-HotStuff) mejora significativamente el rendimiento, manteniendo alta tolerancia a fallos.

Seg煤n los datos del Whitepaper, Narwhal-Hotstuff logra m谩s de `130,000 tx/sec` con una latencia inferior a 2 segundos en una WAN, en comparaci贸n con `1,800 tx/sec` a 1 segundo de latencia para Hotstuff. La adici贸n de trabajadores aumenta linealmente el rendimiento a `600,000 tx/sec` sin aumento de latencia. Adem谩s, el protocolo Tusk ha sido dise帽ado para trabajar con Narwhal y lograr un rendimiento 贸ptimo incluso bajo condiciones de fallo.

## M贸dulo de Consenso
En el funcionamiento del secuenciador Kraken, el m贸dulo de consenso desempe帽a un papel fundamental al ofrecer diversas alternativas para lograr acuerdos en el estado compartido. Estas opciones abarcan desde enfoques simples hasta esquemas m谩s complejos, como el **FCFS (First-Come, First-Served)**, que organiza tareas seg煤n su recepci贸n, **PGA (Practical Byzantine Fault Tolerance)**, un algoritmo que busca acuerdos en sistemas distribuidos a pesar de fallos o nodos maliciosos, y tambi茅n esquemas m谩s sofisticados como **Bullshark**, **Tendermint** y **Hotstuff**.

- [**HotStuff:**](https://arxiv.org/pdf/1803.05069.pdf) es un protocolo de consenso basado en el algoritmo PBFT que destaca por su enfoque en la optimizaci贸n de la latencia y el rendimiento. Su dise帽o permite la replicaci贸n de estado a alta velocidad en sistemas distribuidos. Introduciendo un enfoque basado en tolerancia a fallos bizantinos, HotStuff capacita a un l铆der confiable para guiar el protocolo hacia el consenso en l铆nea con el retraso real de la red, en contraposici贸n al retraso m谩ximo, obteniendo una propiedad denominada capacidad de respuesta. Este logro se complementa con una complejidad de comunicaci贸n lineal en funci贸n del n煤mero de r茅plicas involucradas. En la esencia de su estructura, HotStuff supera el desaf铆o de la replicaci贸n de la m谩quina de estado (SMR), logrando aplicar comandos de manera secuencial y coherente. En el n煤cleo de SMR reside un protocolo que rige la determinaci贸n de un registro en crecimiento de solicitudes de comandos procedentes de los clientes. De manera conjunta, un grupo de r茅plicas de la m谩quina de estado lleva a cabo la ejecuci贸n de estos comandos en orden secuencial y coherente. Si bien gran parte de la discusi贸n excluye al cliente, la literatura est谩ndar aborda aspectos relativos a la numeraci贸n y deduplicaci贸n de solicitudes de clientes.

- [**Bullshark:**](https://arxiv.org/pdf/2201.05677.pdf) BullShark es un protocolo de difusi贸n at贸mica asincr贸nica basado en gr谩ficos ac铆clicos dirigidos (DAG) que est谩 optimizado para el caso sincr贸nico com煤n. A diferencia de otros protocolos asincr贸nicos basados en DAG, BullShark proporciona una ruta r谩pida de baja latencia que explota per铆odos sincr贸nicos y elimina la necesidad de mecanismos de cambio de vista y sincronizaci贸n de vista notoriamente complejos. BullShark logra esto manteniendo todas las propiedades deseables de su predecesor DAG-Rider, incluyendo una complejidad de comunicaci贸n amortizada 贸ptima, equidad y vida asincr贸nica, y garantizando la seguridad incluso ante un adversario cu谩ntico.

Mediante esta gama de opciones de consenso, Kraken se adapta con flexibilidad a diversos escenarios y requerimientos.

## M贸dulo de Ejecuci贸n
Ahora enfoqu茅monos en el motor de ejecuci贸n, el componente esencial encargado de procesar las transacciones en la m谩quina de estado. En Starknet, el sistema operativo est谩 implementado en Rust, y la ejecuci贸n puede llevarse a cabo mediante [Cairo Native](https://github.com/lambdaclass/cairo_native) (un compilador que transforma el c贸digo de representaci贸n intermedia "Sierra" de Cairo en c贸digo de m谩quina a trav茅s de MLIR y LLVM) o [Cairo-rs](https://github.com/lambdaclass/cairo-vm) (una implementaci贸n m谩s r谩pida y segura de la m谩quina virtual de Cairo en Rust). Esta adaptabilidad a trav茅s de m煤ltiples opciones garantiza una operaci贸n eficiente y segura en el procesamiento de las transacciones.

### M贸dulos Intercambiables
Una caracter铆stica clave de Kraken es su capacidad de intercambiar m贸dulos. Esto implica que la implementaci贸n subyacente en la comunicaci贸n del Mempool, el protocolo de Consenso o el Motor de Ejecuci贸n puede personalizarse y adaptarse seg煤n las necesidades espec铆ficas de la red.

Adem谩s, para mantener y persistir el estado, Kraken utiliza un m贸dulo de Estado que implementa [PhotonDB](https://github.com/photondb/photondb) en una primera iteraci贸n. PhotonDB, un motor de almacenamiento de alto rendimiento dise帽ado para hardware y plataformas modernas, asegura una gesti贸n adecuada y segura de los datos en el entorno descentralizado de Kraken.

En resumen, Kraken emerge como un poderoso secuenciador descentralizado dise帽ado por Lambda Class para abordar los desaf铆os de escalabilidad en Starknet. A trav茅s de su enfoque en m贸dulos intercambiables, Kraken ofrece flexibilidad y personalizaci贸n, permitiendo adaptar su funcionamiento a diferentes necesidades y contextos. Adem谩s, su incorporaci贸n de tecnolog铆as avanzadas como Narwhal, HotStuff, Bullshark o PhotonDB que contribuyen a mantener la coherencia y seguridad del estado en la red distribuida. 

En 煤ltima instancia, el secuenciador Kraken no solo demuestra su capacidad para procesar transacciones eficientemente, sino que tambi茅n juega un papel esencial en la b煤squeda continua de la descentralizaci贸n en el Starknet.